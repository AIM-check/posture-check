<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>MediaPipe Pose - 右脇角度測定</title>
  <style>
    canvas { position: absolute; top: 0; left: 0; }
    video { display: none; }
    #angleText {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-size: 24px;
      background-color: rgba(0,0,0,0.5);
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <video id="video" playsinline autoplay></video>
  <canvas id="canvas"></canvas>
  <div id="angleText">右脇角度: --°</div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    const videoElement = document.getElementById("video");
    const canvasElement = document.getElementById("canvas");
    const canvasCtx = canvasElement.getContext("2d");
    const angleText = document.getElementById("angleText");

    function toDegrees(radians) {
      return radians * (180 / Math.PI);
    }

    function calculateAngle(A, B, C) {
      const AB = { x: A.x - B.x, y: A.y - B.y };
      const CB = { x: C.x - B.x, y: C.y - B.y };
      const dot = AB.x * CB.x + AB.y * CB.y;
      const magAB = Math.sqrt(AB.x ** 2 + AB.y ** 2);
      const magCB = Math.sqrt(CB.x ** 2 + CB.y ** 2);
      const angle = Math.acos(dot / (magAB * magCB));
      return Math.round(toDegrees(angle));
    }

    const pose = new Pose({
      locateFile: (file) =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`,
    });

    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5,
    });

    pose.onResults((results) => {
      canvasElement.width = videoElement.videoWidth;
      canvasElement.height = videoElement.videoHeight;

      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0);

      if (!results.poseLandmarks) return;

      const rShoulder = results.poseLandmarks[12];
      const rElbow = results.poseLandmarks[14];
      const rHip = results.poseLandmarks[24];

      // 脇の角度 = 肩-肘-腰の角度
      const angle = calculateAngle(rShoulder, rElbow, rHip);
      angleText.textContent = `右脇角度: ${angle}°`;

      // ランドマークの可視化
      for (let lm of [rShoulder, rElbow, rHip]) {
        canvasCtx.beginPath();
        canvasCtx.arc(lm.x * canvasElement.width, lm.y * canvasElement.height, 6, 0, 2 * Math.PI);
        canvasCtx.fillStyle = "red";
        canvasCtx.fill();
      }
    });

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await pose.send({ image: videoElement });
      },
      width: 640,
      height: 480,
    });

    camera.start();
  </script>
</body>
</html>
