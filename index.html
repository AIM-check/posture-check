<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>右脇角度チェックツール</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <style>
      canvas { border: 1px solid #ccc; }
    </style>
  </head>
  <body>
    <video class="input_video" style="display:none;"></video>
    <canvas class="output_canvas" width="640" height="480"></canvas>

    <script>
      const videoElement = document.getElementsByClassName('input_video')[0];
      const canvasElement = document.getElementsByClassName('output_canvas')[0];
      const canvasCtx = canvasElement.getContext('2d');

      function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.poseLandmarks) {
          drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, { color: '#00FF00' });
          drawLandmarks(canvasCtx, results.poseLandmarks, { color: '#FF0000', radius: 4 });

          const rShoulder = results.poseLandmarks[12];
          const rElbow = results.poseLandmarks[14];
          const rHip = results.poseLandmarks[24];

          if (rShoulder && rElbow && rHip) {
            const angle = getAngle(rShoulder, rElbow, rHip);
            canvasCtx.fillStyle = 'black';
            canvasCtx.font = '20px sans-serif';
            canvasCtx.fillText(`右脇角度: ${Math.round(angle)}°`, 10, 30);
          }
        }

        canvasCtx.restore();
      }

      function getAngle(a, b, c) {
        const ab = { x: a.x - b.x, y: a.y - b.y };
        const cb = { x: c.x - b.x, y: c.y - b.y };
        const dot = ab.x * cb.x + ab.y * cb.y;
        const abLen = Math.hypot(ab.x, ab.y);
        const cbLen = Math.hypot(cb.x, cb.y);
        const angle = Math.acos(dot / (abLen * cbLen));
        return (angle * 180) / Math.PI;
      }

      const pose = new Pose({
        locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
      });
      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        enableSegmentation: false,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });
      pose.onResults(onResults);

      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await pose.send({ image: videoElement });
        },
        width: 640,
        height: 480
      });
      camera.start();
    </script>
  </body>
</html>
