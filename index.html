<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>1カメラ Mediapipe Pose チェック</title>
  <link rel="icon" href="data:,">
  <style>
    video, canvas {
      width: 640px;
      height: 480px;
      border: 1px solid gray;
    }
  </style>
</head>
<body>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>

  <script type="module">
    import { FilesetResolver, PoseLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
      video.srcObject = stream;
      return new Promise((resolve) => {
        video.onloadedmetadata = () => resolve();
      });
    }

    async function main() {
      await setupCamera();

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
      );

      const poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath:
            "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/1/pose_landmarker_lite.task"
        },
        runningMode: "VIDEO",
        numPoses: 1
      });

      function calculateRightArmpitAngle(landmarks) {
        const shoulder = landmarks[12]; // 右肩
        const elbow = landmarks[14];    // 右肘
        const hip = landmarks[24];      // 右腰
        if (!shoulder || !elbow || !hip) return null;

        const ax = elbow.x - shoulder.x;
        const ay = elbow.y - shoulder.y;
        const bx = hip.x - shoulder.x;
        const by = hip.y - shoulder.y;
        const dot = ax * bx + ay * by;
        const magA = Math.sqrt(ax * ax + ay * ay);
        const magB = Math.sqrt(bx * bx + by * by);
        const angle = Math.acos(dot / (magA * magB));
        return Math.round((angle * 180) / Math.PI);
      }

      async function render() {
        const now = performance.now();
        const result = await poseLandmarker.detectForVideo(video, now);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        if (result.landmarks && result.landmarks.length > 0) {
          const lm = result.landmarks[0];
          for (const pt of lm) {
            ctx.beginPath();
            ctx.arc(pt.x * canvas.width, pt.y * canvas.height, 4, 0, Math.PI * 2);
            ctx.fillStyle = 'red';
            ctx.fill();
          }

          const angle = calculateRightArmpitAngle(lm);
          if (angle !== null) {
            ctx.fillStyle = 'black';
            ctx.font = '20px sans-serif';
            ctx.fillText(`右脇角度: ${angle}°`, 10, 30);
          }
        }

        requestAnimationFrame(render);
      }

      render();
    }

    main();
  </script>
</body>
</html>
