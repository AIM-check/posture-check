<!DOCTYPE html>
<html lang="ja">
<head><meta charset="UTF-8"><title>右脇角度チェック（1カメラ）</title></head>
<body>
  <video id="video" autoplay muted playsinline width="640" height="480"></video>
  <canvas id="canvas" width="640" height="480"></canvas>
  <div id="angleDisplay">右脇の角度: --- 度</div>

  <script type="module">
    import * as mpPose from 'https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js';
    import * as mpDrawing from 'https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.5/drawing_utils.js';

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const angleDisplay = document.getElementById('angleDisplay');

    // カメラ起動
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => { video.srcObject = stream });

    // Poseインスタンス作成
    const pose = new mpPose.Pose({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`
    });

    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: false,
      smoothSegmentation: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    pose.onResults(results => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      if (!results.poseLandmarks) return;
      mpDrawing.drawConnectors(ctx, results.poseLandmarks, mpPose.POSE_CONNECTIONS, { color: '#00FF00' });
      mpDrawing.drawLandmarks(ctx, results.poseLandmarks, { color: '#FF0000', radius: 4 });

      // 右肩・右肘・右腰のランドマーク取得
      const R_SHOULDER = results.poseLandmarks[12];
      const R_ELBOW = results.poseLandmarks[14];
      const R_HIP = results.poseLandmarks[24];

      if (R_SHOULDER.visibility > 0.5 && R_ELBOW.visibility > 0.5 && R_HIP.visibility > 0.5) {
        // ベクトル計算
        const vec1 = [R_SHOULDER.x - R_ELBOW.x, R_SHOULDER.y - R_ELBOW.y];
        const vec2 = [R_HIP.x - R_ELBOW.x, R_HIP.y - R_ELBOW.y];

        const dot = vec1[0]*vec2[0] + vec1[1]*vec2[1];
        const len1 = Math.hypot(vec1[0], vec1[1]);
        const len2 = Math.hypot(vec2[0], vec2[1]);
        const angleRad = Math.acos(dot / (len1 * len2));
        const angleDeg = Math.round((angleRad * 180) / Math.PI);

        angleDisplay.textContent = `右脇の角度: ${angleDeg} 度`;
      } else {
        angleDisplay.textContent = '右脇の角度: --- 度';
      }
    });

    async function start() {
      const camera = new Camera(video, {
        onFrame: async () => { await pose.send({ image: video }); },
        width: 640,
        height: 480
      });
      camera.start();
    }

    // Cameraが提供されていないため簡易的な代替を使用
    video.addEventListener('loadeddata', async () => {
      const loop = async () => {
        await pose.send({ image: video });
        requestAnimationFrame(loop);
      };
      loop();
    });

  </script>
</body>
</html>
